<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Golf AI</title>
    <link rel="manifest" href="/static/manifest.json">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary: #88B04B;
            /* Pastel Green */
            --secondary: #92A8D1;
            /* Pastel Blue */
            --bg: #F7F9FC;
            --card-bg: #FFFFFF;
            --text: #333333;
            --text-light: #888888;
            --accent: #FF6F61;
            /* Pastel Red/Coral */
        }

        body {
            font-family: 'Apple SD Gothic Neo', 'Noto Sans KR', sans-serif;
            background-color: var(--bg);
            margin: 0;
            padding: 0;
            color: var(--text);
            -webkit-tap-highlight-color: transparent;
        }

        /* Header */
        header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 15px 20px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 {
            margin: 0;
            font-size: 1.2rem;
            color: var(--primary);
            font-weight: 700;
        }

        .settings-btn {
            background: none;
            border: none;
            font-size: 1.2rem;
            color: var(--text-light);
            cursor: pointer;
        }

        /* Filter Layout Optimization */
        .filter-container {
            padding: 15px 20px;
            background: white;
            margin-bottom: 10px;
        }

        .filter-top-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .date-picker-btn {
            flex: 1;
            margin-bottom: 0;
            /* Override previous margin */
        }

        .search-btn-small {
            width: 50px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .search-btn-small:active {
            transform: scale(0.95);
        }

        /* Date Section Header */
        .date-section-header {
            padding: 20px 20px 10px 20px;
            font-size: 1.1rem;
            font-weight: 800;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .date-section-header::after {
            content: '';
            flex: 1;
            height: 1px;
            background: #eee;
        }

        /* Source Colors */
        .source-teescan {
            color: #E57373;
            /* Pastel Red */
            font-weight: 700;
        }

        .source-golfpang {
            color: #64B5F6;
            /* Pastel Blue */
            font-weight: 700;
        }

        /* Detail Item Layout */
        .detail-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            /* Time | Source | Price */
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f9f9f9;
            font-size: 0.9rem;
        }

        .detail-row div:nth-child(1) {
            text-align: left;
        }

        .detail-row div:nth-child(2) {
            text-align: center;
        }

        .detail-row div:nth-child(3) {
            text-align: right;
            font-weight: bold;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-light);
            display: none;
        }

        /* --- Responsive Design (Desktop) --- */
        @media (min-width: 768px) {
            body {
                background-color: #f0f2f5;
            }

            /* Main Header */
            body>header {
                max-width: 1200px;
                margin: 0 auto;
                background: white;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            }

            /* Filter Section */
            .filter-container {
                max-width: 1160px;
                /* 1200 - padding */
                margin: 20px auto;
                border-radius: 16px;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.02);
            }

            /* Card List Grid */
            .card-list {
                max-width: 1200px;
                margin: 0 auto;
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
                gap: 20px;
                padding-bottom: 40px;
            }

            .date-section-header {
                grid-column: 1 / -1;
                /* Header spans full width */
                margin-top: 20px;
            }

            /* Onboarding Modal for Desktop */
            #onboarding {
                background: rgba(0, 0, 0, 0.6);
                /* Dimmed overlay */
                backdrop-filter: blur(5px);
                display: none;
                /* Flex when active via JS */
                align-items: center;
                justify-content: center;
            }

            .onboarding-modal-inner {
                width: 500px;
                max-height: 80vh;
                background: white;
                border-radius: 20px;
                display: flex;
                flex-direction: column;
                box-shadow: 0 20px 50px rgba(0, 0, 0, 0.2);
                overflow: hidden;
                position: relative;
            }

            .onboarding-header {
                padding: 20px;
                border-bottom: 1px solid #eee;
                background: white;
            }

            .onboarding-content {
                overflow-y: auto;
                padding: 20px;
            }

            .save-btn {
                position: static;
                /* Not sticky inside modal */
                border-radius: 0;
            }
        }

        /* Mobile Specific Adjustments for Onboarding Header */
        @media (max-width: 767px) {
            .onboarding-modal-inner {
                display: flex;
                flex-direction: column;
                height: 100%;
            }

            .onboarding-header {
                /* Replicate original header styles for mobile inside the wrapper */
                background: rgba(255, 255, 255, 0.95);
                backdrop-filter: blur(10px);
                padding: 15px 20px;
                display: flex;
                justify-content: space-between;
                align-items: center;
                border-bottom: 1px solid #eee;
            }
        }
    </style>
</head>

<body>

    <!-- Onboarding / Settings -->
    <!-- Onboarding / Settings -->
    <div id="onboarding">
        <div class="onboarding-modal-inner">
            <header class="onboarding-header">
                <h1>관심 구장 설정</h1>
                <button class="settings-btn" onclick="closeSettings()"><i class="fa-solid fa-xmark"></i></button>
            </header>
            <div class="onboarding-content">
                <div class="region-tabs" id="regionTabs">
                    <!-- Tabs injected by JS -->
                </div>
                <div class="club-grid" id="clubList">
                    <!-- Clubs injected by JS -->
                </div>
            </div>
            <button class="save-btn" onclick="saveSettings()">저장하고 시작하기</button>
        </div>
    </div>

    <!-- Main App -->
    <header>
        <h1>Golf AI</h1>
        <button class="settings-btn" onclick="openSettings()"><i class="fa-solid fa-gear"></i></button>
    </header>

    <div class="filter-container">
        <div class="filter-top-row">
            <div class="date-picker-btn" id="datePickerBtn">
                <span><i class="fa-regular fa-calendar"></i> 날짜 선택</span>
                <i class="fa-solid fa-chevron-down"></i>
            </div>
            <button class="search-btn-small" onclick="loadData()">
                <i class="fa-solid fa-magnifying-glass"></i>
            </button>
        </div>
        <div class="time-chips" id="timeChips">
            <!-- Time chips injected by JS -->
        </div>
    </div>

    <div class="loading" id="loading">
        <i class="fa-solid fa-spinner fa-spin fa-2x"></i>
        <p>최저가를 찾고 있습니다...</p>
    </div>

    <div class="card-list" id="cardList">
        <!-- Cards injected by JS -->
    </div>

    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ko.js"></script>
    <script>
        // --- State ---
        let allClubs = {}; // { "경기": [...], "충청": [...] }
        let selectedClubs = new Set();
        let selectedDates = [];
        let selectedTimes = new Set();
        let currentRegion = "경기";
        let availableDates = []; // [NEW] Dates with data

        // --- Init ---
        document.addEventListener('DOMContentLoaded', async () => {
            // Service Worker
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/static/service-worker.js');
            }

            // Load Clubs
            // Render Time Chips
            renderTimeChips();

            // Load Clubs & Available Dates
            await Promise.all([fetchClubs(), fetchAvailableDates()]);

            // Date Picker (Init after availableDates are fetched)
            flatpickr("#datePickerBtn", {
                mode: "multiple",
                dateFormat: "Y-m-d",
                minDate: "today",
                disableMobile: true, // [NEW] Force JS picker for better multiple date support
                enable: availableDates,
                locale: "ko",
                onChange: (dates, dateStr) => {
                    selectedDates = dateStr.split(', ').filter(d => d);
                    document.querySelector('#datePickerBtn span').innerHTML =
                        selectedDates.length > 0 ? `<i class="fa-regular fa-calendar"></i> ${selectedDates[0]} 외 ${selectedDates.length - 1}일` : `<i class="fa-regular fa-calendar"></i> 날짜 선택`;
                }
            });

            // Check LocalStorage
            const saved = localStorage.getItem('favoriteClubs');
            if (saved) {
                selectedClubs = new Set(JSON.parse(saved));

                // Default: Select Today if available, or first available date
                if (availableDates.length > 0) {
                    // Check if today is in availableDates
                    const todayStr = new Date().toISOString().split('T')[0];
                    if (availableDates.includes(todayStr)) {
                        selectedDates = [todayStr];
                    } else {
                        selectedDates = [availableDates[0]];
                    }

                    // Update UI
                    document.querySelector('#datePickerBtn span').innerHTML = `<i class="fa-regular fa-calendar"></i> ${selectedDates[0]}`;

                    // Initial Load
                    loadData();
                }
            } else {
                openSettings();
            }
        });

        // --- API ---
        async function fetchClubs() {
            const res = await fetch('/api/clubs');
            allClubs = await res.json();
            renderSettings();
        }

        async function fetchAvailableDates() {
            try {
                const res = await fetch('/api/available_dates');
                availableDates = await res.json();
            } catch (e) {
                console.error("Failed to fetch dates", e);
            }
        }

        async function loadData() {
            if (selectedDates.length === 0 || selectedClubs.size === 0) return;

            document.getElementById('loading').style.display = 'block';
            document.getElementById('cardList').innerHTML = '';

            try {
                const res = await fetch('/api/prices', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        dates: selectedDates,
                        times: Array.from(selectedTimes),
                        clubs: Array.from(selectedClubs)
                    })
                });
                const data = await res.json();
                renderCards(data);
            } catch (e) {
                console.error(e);
                alert("데이터를 불러오는데 실패했습니다.");
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        // --- UI Rendering ---
        function renderSettings() {
            const tabs = document.getElementById('regionTabs');
            tabs.innerHTML = '';
            Object.keys(allClubs).forEach(region => {
                const t = document.createElement('div');
                t.className = `tab ${region === currentRegion ? 'active' : ''}`;
                t.innerText = region;
                t.onclick = () => {
                    currentRegion = region;
                    renderSettings(); // Re-render to update active tab and list
                };
                tabs.appendChild(t);
            });

            const list = document.getElementById('clubList');
            list.innerHTML = '';
            const clubs = allClubs[currentRegion] || [];
            clubs.forEach(c => {
                const el = document.createElement('div');
                el.className = `club-check ${selectedClubs.has(c.name) ? 'checked' : ''}`;
                el.innerHTML = `<i class="fa-solid fa-check"></i> ${c.name}`;
                el.onclick = () => {
                    if (selectedClubs.has(c.name)) selectedClubs.delete(c.name);
                    else selectedClubs.add(c.name);
                    el.classList.toggle('checked');
                };
                list.appendChild(el);
            });
        }

        function renderTimeChips() {
            const container = document.getElementById('timeChips');
            container.innerHTML = '';
            for (let i = 5; i <= 19; i++) {
                const hour = i.toString().padStart(2, '0');
                const chip = document.createElement('div');
                chip.className = 'chip';
                chip.innerText = `${hour}시`;
                chip.onclick = () => toggleTime(chip, hour);
                container.appendChild(chip);
            }
        }

        function renderCards(items) {
            const list = document.getElementById('cardList');
            list.innerHTML = '';

            if (items.length === 0) {
                list.innerHTML = '<div style="text-align:center; padding:20px; color:#888;">조건에 맞는 티타임이 없습니다.</div>';
                return;
            }

            // 1. Group by Date
            const byDate = {};
            items.forEach(item => {
                if (!byDate[item.date]) byDate[item.date] = [];
                byDate[item.date].push(item);
            });

            // 2. Sort Dates
            const sortedDates = Object.keys(byDate).sort();

            sortedDates.forEach(date => {
                // Render Date Header
                const dateHeader = document.createElement('div');
                dateHeader.className = 'date-section-header';
                dateHeader.innerText = `${date} (${getDayName(date)})`;
                list.appendChild(dateHeader);

                // 3. Group by Club within this Date
                const byClub = {};
                byDate[date].forEach(item => {
                    if (!byClub[item.club_name]) byClub[item.club_name] = [];
                    byClub[item.club_name].push(item);
                });

                // 4. Render Club Cards
                Object.keys(byClub).forEach(clubName => {
                    const groupItems = byClub[clubName];
                    // Sort by price ascending to find best
                    groupItems.sort((a, b) => a.price - b.price);
                    const best = groupItems[0];

                    const diffVal = best.diff;
                    let diffHtml = '<span class="diff same">-</span>';
                    if (diffVal > 0) diffHtml = `<span class="diff up">▲ ${diffVal.toLocaleString()}</span>`;
                    else if (diffVal < 0) diffHtml = `<span class="diff down">▼ ${Math.abs(diffVal).toLocaleString()}</span>`;

                    // Source Color Class
                    const sourceClass = best.source.toLowerCase().includes('teescan') ? 'source-teescan' : 'source-golfpang';

                    const card = document.createElement('div');
                    card.className = 'card';
                    card.onclick = (e) => {
                        card.classList.toggle('expanded');
                    };

                    // Summary View
                    let html = `
                        <div class="card-summary">
                            <div class="card-header">
                                <span class="club-name">${best.club_name}</span>
                                <span class="tee-time" style="background:var(--primary); color:white;">${groupItems.length}개 타임</span>
                            </div>
                            <div class="price-row">
                                <span class="price">₩${best.price.toLocaleString()}~</span>
                                ${diffHtml}
                            </div>
                            <div class="card-footer">
                                <span>최저가: ${best.time}</span>
                                <span class="${sourceClass}">${best.source}</span>
                            </div>
                        </div>
                        <div class="card-details">
                    `;

                    // Detail View (Time | Source | Price)
                    // Sort details by time? Or price? User said "Best price time first" for summary.
                    // For details, usually time order is better for scheduling, or price order.
                    // Let's sort by Price ascending as per general user preference for "Best Prices".
                    // Or Time? "상세 타임 볼때는... 시간 / 데이터소스 / 가격"
                    // Let's stick to Price ascending (already sorted above).

                    groupItems.forEach(item => {
                        const itemSourceClass = item.source.toLowerCase().includes('teescan') ? 'source-teescan' : 'source-golfpang';
                        html += `
                            <div class="detail-row">
                                <div>${item.time}</div>
                                <div class="${itemSourceClass}">${item.source}</div>
                                <div>₩${item.price.toLocaleString()}</div>
                            </div>
                        `;
                    });

                    html += `</div>`; // Close card-details
                    card.innerHTML = html;
                    list.appendChild(card);
                });
            });
        }

        // --- Helpers ---
        function openSettings() {
            document.getElementById('onboarding').style.display = 'flex';
            renderSettings();
        }

        function closeSettings() {
            document.getElementById('onboarding').style.display = 'none';
        }

        function saveSettings() {
            localStorage.setItem('favoriteClubs', JSON.stringify(Array.from(selectedClubs)));
            closeSettings();
            loadData();
        }

        function toggleTime(el, time) {
            if (selectedTimes.has(time)) selectedTimes.delete(time);
            else selectedTimes.add(time);
            el.classList.toggle('active');
            // Removed auto-load: loadData();
        }

        function getDayName(dateStr) {
            const days = ['일', '월', '화', '수', '목', '금', '토'];
            return days[new Date(dateStr).getDay()];
        }
    </script>
</body>

</html>